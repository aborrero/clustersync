#!/bin/bash

PID=$$
LIBCLUSTERSYNC="../lib/libclustersync"
THIS="`uname -n`"
[ ! -z "$THIS" ] || { echo "E: Unable to get the name of this machine" >&2 ; exit 1 ; }

# Loading libraries, config and validating execution
source $LIBCLUSTERSYNC || { echo "E: Unable to load [$LIBCLUSTERSYNC]" >&2 ; exit 1 ; }
source $CONFIG_FILE || { mensaje "E: Unable to load [$CONFIG_FILE]" ; exit 1 ; }
check_root || { mensaje "E: Not running as root" ; exit 1 ; }
validate_execution || { mensaje "E: Unable to run. The lock file [$LOCK_FILE] already exists and don't belong to this instace." ; exit 1 ; }
mensaje "I: Loading complete"


mensaje "DEBUG-2: Moving to /"
cd / 2> /dev/null > /dev/null
[ $? -ne 0 ] && mensaje "DEBUG-1: Failed to move to /"

# Traps declaration
trap clean_up SIGINT SIGTERM SIGKILL SIGTSTP SIGQUIT
trap "reload || exit 1" SIGHUP SIGCONT


# The main daemon loop
while true
do
	validate_required_bins || { echo "E: Terminating..." ; exit 1 ; }
	loop_sync_files
	wait_timeout
done

exit 0
